
## 第二章: Internet 地址结构

### 1. 引言

本章介绍 Internet 中使用的网络层地址，又称 IP 地址。现在，连接到 Internet 的每个设备至少有一个 IP 地址，即基于 TCP / IP 专用网络协议的设备都需要 IP。任何情况下，由 IP 路由器（第 5 章）内的转发程序实现 IP 地址的流量去向和来源。IP 地址通常被 DNS（域名解析服务，见第 11 章）屏蔽在用户视线之外，DNS 让大多数用户直接使用域名，而不是一个 IP 地址。

为了了解 Internet 如何识别主机和路由器，并在它们之间实现流量交付，必须了解 IP 地址：管理、结构和用途。不论是连接到 Internet 还是专用网络的设备，为它们分配的地址必须经过协调，这样就不会重复使用网络中的其他地址。成组的 IP 地址被分配给用户和组织。这些地址的拥有者再将它们分配给设备，这通常根据某些编号方案进行。对于全球性的 Internet 地址，一个分层结构管理实体帮助用户和服务提供商分配地址。个人用户通常由 Internet 服务提供商（ISP）分配地址，通过支付费用用来获得地址和执行路由。

### 2. IP 地址表示方法

- IPv4: 点分十进制表示法
- IPv6: 表示方法采用冒号分割的 4 位 16 进制字符，中间最长的 0 用 :: 表示，且 :: 只能有一个，否则难以区分两个 :: 究竟多少个 0

### 3. IP 地址初始划分办法

#### 3.1 地址分类寻址

IP 地址最初被设计为 IP 32 位中第一位为 0 的 A 类，第一二位为 10 的网络地址为 B 类网络，前三位为 110 的地址被划分为 C 类网络。以这些地址位开头的都将作为单播地址。

在基于地址分类法的 Internet 第一个十年（20 世纪 80 年代）增长中，还能应付。此后，每一个新网段被添加到 Internet 中，对于采用几种协调的方式，为其分配一个 A 类、B 类、C 类网络号变得很不方便。且 A 类和 B 类网络通常会浪费掉很多主机号，而 C 类网络号又不能提供足够多的主机号。

#### 3.2 基于地址分类的子网寻址

为了解决单纯使用分类寻址带来的难以为新网段分配新网络号，以及 20 世纪 80 年代初局域网发展和增加，人们很自然想到了一种方式：当一个站点计入到 Internet 后利用其网络号作为子网的网络前缀，并在站点内部实现对主机号自治。即根据分配到的网络号 + 子网位数 + 主机位数，管理内部的网络。

这样，在不改变 Internet 核心路由基础设施的情况下，将更好解决新接入 Internet 设备 IP 分配问题。此方法仅用于单个站点内部，对于 Internet 上的其他部分，仅能看到该站点的 A 类、B 类和 C 类部分，并不清楚站点内部如何划分和管理内部主机。此功能方法称之为子网寻址 [RFC0950]。通过子网寻址，一个站点被分配一个 A 类、B 类、C 类的网络号，保留一些剩余主机号进一步对站内进行分配。本质上来说，子网寻址为 IP 地址结构增加了一个额外的部分，但它没有为地址增加长度。所以，一个站点管理员能在子网数和每一个子网中的主机数中折中，同时又不影响其他站点。

子网寻址为站点本身提供了灵活性，但也增加了成本：由于站点内部的管理子网字段和主机字段的定义是自己指定的（与网络号分类无关），所以需要采用新的方式确定内部的子网部分和主机部分。在子网出现前，可以直接从网络号中获得。

#### 3.3 为分类子网寻址而生：子网掩码

子网掩码现在的标识方法为：网络号加子网位数。子网掩码是主机或路由器用来从 IP 地址中提取网络和子网信息的分配位。子网掩码与其对应的 IP 地址具有相同的长度（IPv4 为 32 位，IPv6 为 128 位）。它们像 IP 地址一样被配置，无论是静态的还是动态的（例如，通过 DHCP）。对于 IPv4，子网掩码以点分十进制表示法编写。子网掩码的常见格式是一系列前导 1 后跟 0，前导 1 的数量称为“前缀长度”。

**表 2-4: 各种格式的 IPv4 子网掩码的例子**

| 点分十进制表示 | 容易记的格式 (前缀长度) | 二进制表示 |
|----------------|------------------------|------------|
| 128.0.0.0 | /1 | 10000000 00000000 00000000 00000000 |
| 192.0.0.0 | /2 | 11000000 00000000 00000000 00000000 |
| 224.0.0.0 | /3 | 11100000 00000000 00000000 00000000 |
| 240.0.0.0 | /4 | 11110000 00000000 00000000 00000000 |
| 248.0.0.0 | /5 | 11111000 00000000 00000000 00000000 |
| 252.0.0.0 | /6 | 11111100 00000000 00000000 00000000 |
| 255.0.0.0 | /8 | 11111111 00000000 00000000 00000000 |
| 255.255.0.0 | /16 | 11111111 11111111 00000000 00000000 |
| 255.255.255.0 | /24 | 11111111 11111111 11111111 00000000 |
| 255.255.255.255 | /32 | 11111111 11111111 11111111 11111111 |

表 2-5 列出了 IPv6 的一些例子。

**表 2-5: 各种格式的 IPv6 子网掩码的例子**

| 十六进制表示 | 容易记的格式 (前缀长度) | 二进制表示 |
|--------------|------------------------|------------|
| ffff:ffff:ffff:ffff:: | /64 | 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 |
| ff00:: | /8 | 11111111 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 |

子网掩码的功能是：路由器使用它们来定义 IP 地址的网络/子网部分和主机部分之间的边界。子网掩码中的 '1' 表示属于网络/子网部分的位（用于转发数据），而 '0' 表示属于主机 ID 的位。参考表 2-4，可以看到 IPv4 地址如 128.32.1.14 是如何被处理的。

#### 3.4 可变长度子网掩码

以上通过子网掩码，将分配给站点的网络号，划分为多个相同大小的子网，并根据网络管理员的合理要求使每个子网能支持相同数量的主机号。但是还有种方法，将不同的子网分配不同长度的掩码，这样虽然进一步增加了管理的复杂性，但是也提高了子网结构的灵活性，这是因为不同长度的掩码可容纳不同的主机，网络管理员可根据不同子网的需求灵活分配和管理。

目前，大多数主机、路由器和路由协议支持可变长度子网掩码（VLSM）。即同一个子网中，路由器/主机可以为不同的子网分配不同的掩码长度。

#### 3.6 IPv6 地址和接口标识符

除了比 IPv4 长 4 倍以外，IPv6 使用特殊的数字位前缀表示其地址的通信范围：本地（仅和本机通信）、链路本地（同一网络链路或 IPv6 前缀中的所有主机）、全球（Internet 范围）。

在 IPv6 中，大部分接口同时拥有多个 IPv6 地址。虽然 IPv4 也支持多个地址，但是并不常见。在分配的链路本地地址和全球性 IPv6 地址中，后 64 位以接口标识符（IID）为基础构成一个单播地址，IID 通常为 64 位。同时，IID 采用的是 EUI-64 格式，这里需要提出的是，链路层 MAC 地址也是一种 EUI 段格式，具体名称为 EUI-48。

上文提到的 EUI，在 IEEE 标准中称为拓展唯一标识符。EUI-48 或 EUI-64 中前面 24 位组织唯一标识符（OUI），它由 IEEE 注册权威机构 [IEEERA] 来维护和分配，而除去这 24 位，剩余位则由组织分配。

多年来，很多 IEEE 标准兼容的网络接口地址使用的是 EUI-48，与 EUI-64 最显著的区别就是位数长度不同。其中 EUI 格式中，第一个字节的第 7 位 bit 表示该 EUI 是否用于本地/通用（u 位），第 8 位标识是否是一个组（g 位）。通常在 IPv6 地址中用于标识是否是组播地址。我们只关心没有 EUI 第一个字节的第 8 位没有被设置为 1 的情况。

EUI-64 可以由 EUI-48 生成，生成办法就是在 EUI-48 第三个字节开始插入 FFFE 即可表示为 EUI-64。因此，IID（EUI-64）就可以采用链路层 MAC（EUI-48）地址生成。

### 4. 现代路由系统: CIDR 和聚合

20 世纪 90 年代初期，采用子网寻址缓解增长带来的痛苦后，Internet 面临更严重的规模问题。

1. 1994 年，一半以上 B 类地址已被分配。预计 1995 年 B 类空间将被用尽。
2. 32 位的 IPv4 地址被认为不足以应付 21 世纪初的预期规模。
3. 全球性路由表的条目数（网络号条目），1995 年为 65000 个，随着 A 类、B 类和 C 类的增长，路由性能将受到影响。

这些问题，在 1992 年开始就受到 IETF 中 ROAD（路由和寻址）小组的关注。问题 1 和 3 快速来临，并提出短期解决方案使有效清除 IP 地址分类的缺陷，并提高层次化分配 IP 地址的聚合能力。而 IPv6 则被设想于解决问题 2。

#### 4.1 网络前缀

为了缓解 IPv4 的压力，分类寻址方案通常使用一个类似 VLSM 的方案，并拓展 Internet 路由系统以支持无类别域间路由（CIDR）[RFC4632]。这提供了方便连续分配地址范围的分配方式，此分配方式可以分配包含多于 255 台并少于 65536 台主机的网络号。

使用 CIDR，未经过预定义的任何地址范围可作为一个类的一部分，但需要一个类似于子网掩码的掩码，有时也称为 CIDR 掩码。CIDR 掩码不再局限于一个站点，而对全球性路由系统都是可见的。因此，除了网络号之外，核心 Internet 路由器必须能解释和处理掩码。这个数字组合称为网络前缀，它用于 IPv4 和 IPv6 地址管理。

消除一个 IP 地址中网络和主机号的预定义分隔，将使更细粒度的 IP 地址分配范围成为可能。与分类寻址类似，地址空间分割成块最容易通过数值连续的地址来实现，以便用于某种类型或某些特殊用途。目前，这些分组普遍使用地址空间的前缀表示。一个 n 位的前缀是一个地址的前 n 个位的预定义值。对于 IPv4，n（前缀长度）的值通常在范围 0 ~ 32；对于 IPv6，通常在范围 0 ~ 128。它通常被追加到基本 IP 地址，并且后面跟着一个 / 字符。表 2-6 给出了一些前缀的例子，以及相应的 IPv4 或 IPv6 地址范围。

**表 2-6 前缀的例子及其相应的 IPv4 或 IPv6 地址范围**

| 前缀 | 前缀(二进制) | 地址范围 |
|------|-------------|----------|
| 0.0.0.0/0 | 00000000 00000000 00000000 00000000 | 0.0.0.0 ~ 255.255.255.255 |
| 128.0.0.0/1 | [1]0000000 00000000 00000000 00000000 | 128.0.0.0 ~ 255.255.255.255 |
| 128.0.0.0/24 | [10000000 00000000 00000000] 00000000 | 128.0.0.0 ~ 128.0.0.255 |
| 198.128.128.192/27 | [11000110 10000000 10000000 110]00000 | 198.128.128.192 ~ 198.128.128.223 |
| 165.195.130.107/32 | [10100101 11000011 10000010 01101011] | 165.195.130.107 |
| 2001:db8::/32 | [00100000 00000001 00001101 10111000] 00000000... | 2001:db8:: ~ 2001:db8:ffff:ffff:ffff:ffff:ffff:ffff |

在二进制前缀列中，方框内的位是固定的，而剩余的位可以是 0 和 1 的任意组合，从而定义了地址范围。前缀长度越短，对应的地址范围越大。

这种基于前缀的寻址方式（CIDR）取代了旧的分类寻址方案。例如，C 类网络 192.125.3.0 可以写作 192.125.3.0/24 或 192.125.3/24。类似地，A 类网络可以用 /8 表示，B 类网络可以用 /16 表示。

#### 4.2 路由表的聚合

以前，路由器的路由条目是通过增加单条路由应该往哪边转，所以对于不断增长的网络，路由表会越来越大。但是，通过 CIDR 对地址划分范围后，则可以通过网络地址中和本机路由器中的地址范围表进行匹配，很容易就知道应该往哪个方向转发流量。这样，路由表在确定后，增长不会像之前记录单个路由条目一样会随着时间增长不断将路由表变大。因为流量包的网络地址和路由表比对，在路由表中确定它属于哪个范围，向指定端口转发即可实现路由转发。减少了路由表查找量，自然就提高了路由性能。这对于核心路由尤为重要。

通过对以上问题的理解后，很容易发现 20 世纪 90 年代初遇到的问题。当时，没有什么技术可以解决以下问题：在维护 Internet 中到所有目的地的最短路径的同时，又能显著减少路由表的条目。此处，最有名的方法是 20 世纪 70 年代末由 Kleinrock 和 Kamoun 发表的分层路由研究 [KK77]。聚合过程此处不再介绍。

### 5. 特殊用途的地址 (CIDR 表示)

特殊用途地址是指那些不用于标准单播地址分配的地址范围。

**表 2-7 IPv4 特殊用途地址 (定义于 2010 年 1 月)**

| 前缀 | 特殊用途 | 参考文献 |
|------|----------|----------|
| 0.0.0.0/8 | 本地网络主机，仅用作源 IP | RFC 1700 |
| 10.0.0.0/8 | 私有网络（内网）地址，不出现在公网 Internet 上 | RFC 1918 |
| 127.0.0.0/8 | Internet 主机回环地址 | RFC 5735 |
| 169.254.0.0/16 | 链路本地地址 | RFC 3927 |
| 172.16.0.0/12 | 私有网络（内网）地址，不出现在公网 Internet 上 | RFC 1918 |
| 192.0.0.0/24 | IETF 协议分配（IANA 保留） | RFC 5736 |
| 192.0.2.0/24 | TEST-NET 地址，用于文档 | RFC 5737 |
| 192.88.99.0/24 | 用于 6to4 中继 | RFC 3068 |
| 192.168.0.0/16 | 私有网络（内网）地址，不出现在公网 Internet 上 | RFC 1918 |
| 198.18.0.0/15 | 用于基准测试 | RFC 2544 |
| 198.51.100.0/24 | TEST-NET 地址，用于文档 | RFC 5737 |
| 203.0.113.0/24 | TEST-NET 地址，用于文档 | RFC 5737 |
| 224.0.0.0/4 | IPv4 多播地址 | RFC 5771 |
| 240.0.0.0/4 | 保留空间 | RFC 5735 |
| 255.255.255.255/32 | 本地网络广播地址 | RFC 919 |

**表 2-8 IPv6 特殊用途地址 (定义于 2008 年 4 月)**

| 前缀 | 特殊用途 | 参考文献 |
|------|----------|----------|
| ::/0 | 默认路由条目 | RFC 4291 |
| ::/128 | 未指定地址 | RFC 4291 |
| ::1/128 | IPv6 主机回环地址 | RFC 4291 |
| ::ffff:0:0/96 | IPv4 映射地址 | RFC 4291 |
| ::{ipv4-address}/96 | IPv4 兼容地址（已弃用） | RFC 4291 |
| 2001::/32 | Teredo 地址 | RFC 4380 |
| 2001:10::/28 | ORCHI（覆盖路由加密哈希标识符） | RFC 4843 |
| 2001:db8::/32 | 用于文档和示例的地址范围 | RFC 3849 |
| 2002::/16 | 6to4 地址 | RFC 3056 |
| 3ffe::/16 | 用于 6bone 实验（已弃用） | RFC 3701 |
| 5f00::/16 | 用于 6bone 实验（已弃用） | RFC 3701 |
| fc00::/7 | 唯一本地单播地址 | RFC 4193 |
| fe80::/10 | 链路本地单播地址 | RFC 4291 |
| ff00::/8 | IPv6 多播地址 | RFC 4291 |

**关于特殊地址定义时间的说明**

#### 5.1 为什么特殊地址在 2010 年才"定义"?

这里需要澄清一个重要的概念：**2010 年的"定义"实际上是指 RFC 文档的发布时间，而不是这些地址的实际使用时间**。这些特殊地址在 1995 年之前就已经被定义和使用，只是相关的 RFC 文档在 2010 年进行了更新和整理。

#### 5.2 1995-2010 年网络正常运行的关键技术

##### CIDR（无类别域间路由）

- 1993 年引入，1995 年正式部署
- 解决了地址分类寻址的浪费问题
- 允许更灵活的地址分配（如 /27、/28 等）
- 显著提高了 IPv4 地址空间的利用效率

##### NAT（网络地址转换）

- 1994 年 RFC 1631 引入
- 让私有地址可以在公网上使用
- 一个公网 IP 可以支持多个内网设备
- 成为解决地址短缺的核心技术

##### 私有地址空间

- RFC 1918（1996 年）定义了私有地址范围
- 10.0.0.0/8、172.16.0.0/12、192.168.0.0/16
- 这些地址可以在不同组织内重复使用
- 大大缓解了公网地址的压力

#### 5.3 网络架构的演进过程


- 1995年前：分类寻址 + 子网划分
- 1995-2000：CIDR + NAT + 私有地址
- 2000年后：IPv6准备 + 地址优化

#### 5.4 2010 年"定义"的真正含义

这里的"定义"实际上是：

- **标准化整理**：将分散的 RFC 整合，形成统一的规范
- **最佳实践总结**：基于多年使用经验，优化地址分配策略
- **向后兼容**：确保现有网络不受影响，平滑过渡
- **文档完善**：为 IPv6 过渡期提供更清晰的 IPv4 地址管理指南

#### 5.5 总结

1995-2010 年网络正常运行不是因为 2010 年才定义特殊地址，而是因为：

1. **CIDR 技术**让地址分配更高效，减少了地址浪费
2. **NAT 技术**让私有地址可以上网，一个公网 IP 支持多个设备
3. **私有地址空间**解决了地址短缺，不同组织可以重复使用
4. **路由聚合**提高了网络性能，减少了路由表条目

这些技术的组合让 IPv4 地址空间在 IPv6 成熟之前能够继续支撑互联网的快速发展，为全球网络的稳定运行提供了技术保障。

### 6. IP 地址分配

现阶段，IP 地址空间通常被分配为大的块（范围），这由一些分层次的权威机构完成。权威机构是为各种 [所有者] 分配地址空间的组织。[所有者] 通常是 ISP 或其他较小的权威机构。权威机构进场参加与全球单播地址空间分配，权威机构为用户分配一个固定/限时地址块，最后这个层次的最顶部机构是 IANA，它负责分配 IP 地址和 Internet 协议使用的其他号码。

#### 6.1 单播地址

对于单播 IPv4 和 IPv6 地址空间，IANA 将分配权限主要委托给几个地区性 Internet 注册机构 (RIR)，RIR 通过 2003 年创建的号码资源组织 (NRO) 相互协作。

表 2-14 列出了截至 2011 年中期加入 NRO 的一组 RIR。截至 2011 年初，IANA 剩余的 IPv4 单播地址空间将转移给这些 RIR 进行分配。

**表 2-14: 加入 NRO 的地区性 Internet 注册机构 (Regional Internet Registries joining NRO)**

| RIR 名称 | 负责的地区 | 参考文献 |
|----------|------------|----------|
| AfriNIC - 非洲网络信息中心 (African Network Information Centre) | 非洲 (Africa) | `http://www.afrinic.net` |
| APNIC - 亚洲太平洋地区网络信息中心 (Asia Pacific Network Information Centre) | 亚洲/太平洋地区 (Asia/Pacific Region) | `http://www.apnic.net` |
| ARIN - 美洲 Internet 号码注册机构 (American Registry for Internet Numbers) | 北美洲 (North America) | `http://www.arin.net` |
| LACNIC - 拉丁美洲和加勒比地区的 IP 地址注册 (Latin American and Caribbean IP Address Registry) | 拉丁美洲和一些加勒比岛屿 (Latin America and some Caribbean Islands) | `http://lacnic.net/en/index.html` |
| RIPE NCC - 欧洲网络协调中心 (RIPE Network Coordination Centre) | 欧洲、中东、中亚 (Europe, Middle East, Central Asia) | `http://www.ripe.net` |

这些 RIR 实体通常处理较大的地址块（如 IP4AS、IP6AS）。它们将地址空间分配给较小的注册机构和各国的大型 ISP（如澳大利亚和新加坡）。随后，ISP 向其客户提供地址空间。当用户注册 Internet 服务时，他们通常使用 ISP 地址空间的一小部分（通常很小），以地址前缀的形式出现。这些地址范围由客户的 ISP 拥有和管理，被称为提供商可聚合（PA）地址。

#### 6.2 组播地址(略)

### 7. 单播地址分配分类

1. 单个供应商/无网络/单个地址
2. 单个供应商/单个网络/单个地址(家庭)
3. 单个供应商/多个网络/多个地址(组织)
4. 多个供应商/多个网络/多个地址(多宿主--依赖 Internet 接入的持续运营组织)

### 总结

CIDR（无类别域间路由）可以说是互联网开发和部署核心路由系统的根本性变化。CIDR 成功地为分配地址空间提供了更多的灵活性，并通过聚合提升了路由的可扩展性。此外，IPv6 在 20 世纪 90 年代初开始受到更多的重视，这是因为人们预见到很快会需要更多的地址。然而，没有预见到的是，NAT（网络地址转换）的广泛使用显著推迟了 IPv6 的使用，因为连接到互联网的每一台主机不再需要唯一的地址。相反，大型网络使用专用地址空间已经司空见惯。但是，可用于路由的 IP 地址数量最终将减少到零，因此未来将出现一些变化。
