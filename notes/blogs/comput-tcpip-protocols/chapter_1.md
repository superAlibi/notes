

## 第一章：网络概述

计算机发明时并未存在网络，网络出现是出于对计算机数字资料分享、传输的目的而设计。注意此处用 “设计” 表达，是因为 “网络” 这个概念更多是艺术，而不是科学。

在设计时，网络底层传输利用人类已知的物理电气特性、规律，并加以有序或规律性控制，用以表达人类定义的信息、概念。

正如前文所述，如何按照特定规律有序控制并作为信息表达，以实现人类可理解的描述、信息，此部分则为人类概念中的 “协议” 部分内容。

TCP/IP 就是上文中的协议，但 TCP/IP 不用于表达物理特性，而是在 OSI 网络层级中的传输层和网络层中工作。此部分层级的工作已经不涉及物理规律，更多的是表达如何有效传递逻辑控制部分的信息。

工作在利用物理特性、规律进行控制的协议是 OSI 网络模型中的物理层、链路层的协议，包括以太网协议和 WiFi 协议等。但本书更多解读 OSI 网络模型及其以上层级的部分内容，对链路层会涉及一点，但不是主要内容。

协议作为人类定义的描述概念，在牛津辞典中的概念为：

> 国家事务或外交场合的正式程序或规则系统

正如我提到的 OSI 网络层级、模型一样，协议和物理规律结合工作，就是网络体系结构。

该体系结构可以用网络分层来划分，正如物理层就是单纯物理层规律一样，链路层监听物理层规律的特征、规律，用以识别该物理特征、规律是否是网络体系中需要的协议信息。如果满足特定的协议内容则加以处理，并识别是否需要交给网络层，或自身处理。

网络层则监听来自链路层的信息、协议内容，加以解析判断是否有效，在信息有效时，判断信息是否需要在网络层转发，或就在本地处理并交给更上层工作的设备处理。

一般来说，更高层级的网络设备能识别所有同级别及以下设备传递的信息，毕竟不同设备之间传输，底层也属于物理特性的规律表达而来的。

### 1. 体系结构原则

Internet 体系结构在几个目标的指导下建立。在 \[c88] 中，Clark 描述的首要目标是：发展一种重复利用已有的互联网络的技术。这句话本质是 Internet 体系结构应将多种网络互联起来，并在互联的网络上同时运行多个应用。基于这个首要目标，Clark 还提供了以下的二级目标：



1.  Internet 通信在网络或网关（IP 路由器）失效时必须能持续

2.  Internet 必须支持多种类型的通信服务

3.  Internet 体系结构必须兼容多种网络

4.  Internet 体系结构必须允许对其资源的分布式管理

5.  Internet 体系结构必须是经济有效的（军事、管理要求）

6.  Internet 体系结构必须允许低能力主机的连接

7.  Internet 中使用的资源必须是可统计的

上述目标中大部分被设计决策所采纳。但在制定这些体系结构的原则时，会影响到设计者所做的选择，最后少数几种设计方案脱颖而出。接下来会提到：

#### 1.1 分组、连接和数据报

20 世纪 60 年代，网络最初主要用于电话网络。它是针对在一次通话中连接双方通话而设计的，一次通话通常需要在双方之间建立一条连接（在早期就是一条物理线路）。在线路的一端输入一定的数据，经过一定的延时，沿着预先建立的网络交换机路径，在线路另一端以一种可以预测的方式出现。

20 世纪 60 年代，分组交换的概念提出。该概念主要是：将原本需要连续发送的信息，切割、分解为更小的数据块，这些数据块可分别发向多个独立网络路径（多路复用），并在网络目的地上，这些分解数据块可以组合起来（分解和组合在后续章节介绍）。这样可以让网络更加具有弹性，不用担心线路受到物理攻击。基于统计复用可以更好地利用网络链路和交换设备。

这种方式传输信息时，因为不依赖特定网络路径，具有很高的灵活性，但对交换机中统计信息（流量）的可预测性有限。交换机如同数据流通的高速公路，其作为高速公路的瓶颈和阻塞点，任何一个交换机出现故障，都会导致其他交换机繁忙。

针对这种不可预测的特点，又想让通话不被突然的单点故障影响，人们提出了一些分时复用（TDM）和静态复用的替代性技术：在连接上保留一定的处理资源或时间资源。虽然这保证了通话的可预测性，但是却无法让整个网络带宽充分利用，因为可能这部分虚拟电路（交换机上保留的处理和时间资源）并未使用。

对于 “虚拟电路” 这个词汇，需要在每个交换机中为每个虚拟电路连接储存一些信息或状态。结合分组数据中携带的少量信息，这部分少量的信息就是用于索引状态或信息的索引，用于决定是否转发到下一个交换机。当然，索引使用前，已经在每个交换机上建立了状态信息，通过协议来建立、清除连接在交换机中的状态或索引信息。这类网络称为 “面向连接” 的。

无论是建立在线路还是交换的基础上，以上所描述的网络均称为面向连接的网络，是 20 世纪 60 年代前期以及之前最流行的联网方式。在这之后，数据报作为另一种方案得到发展，该方案起源于 CYCLADES \[P73] 系统。该网络体系在数据分组中包含了来源和最终目的地所有的识别信息（不在分组交换机中），这虽然需要更大的数据包，但是不再需要在分组交换机中维护连接状态，可以用于建立一个 “无连接” 的网络，也不再需要使用复杂的信令协议。数据报很快被早期 Internet 设计者接受，这个决定对协议族其他部分有深远影响。

另外有一个关于 “消息边界、记录标记” 的概念。当一个应用程序将多个信息、消息数据发送到网络中，这些信息、消息的分割点可能会被通信协议保留，也可能不会被保留。大多数数据报协议是保留这些分割点的。这样设计很自然，因为数据报也有开始和结束标识。但是在交换网络、虚拟电路网络中，对于连续的几块数据，接收方将按照一个数据块和多个数据块接收，因为这些协议不保留消息边界，所以需要应用程序或者更高级的网络层协议提供消息边界的功能。

#### 1.2 端到端和命运共享论点

当我们设计一个大型系统（操作系统或协议族）时，通常会涉及到什么位置、模块实现哪个功能。

TCP/IP 协议族设计时一个重要原则称为[端到端](https://web.mit.edu/saltzer/www/publications/endtoend/endtoend.pdf)[论点](https://web.mit.edu/saltzer/www/publications/endtoend/endtoend.pdf)：

> 只有在通信系统端角度的应用知识的帮助下，才能完全正确地实现问题中提到的功能。因此，作为通信系统自身的一个特点，不可能提供有疑问的功能。（有时，通信系统提供的一个不完整的功能可能用于提高性能）

这段话认为只有涉及参与通信的终端系统的应用程序或最终用户，才能正确实现通信功能的正确性和完整性，即使协议为正确实现应用程序做了努力，其功能注定不会很完善。总之，这个原则认为重要的功能（例如：差错控制、加密、交付确认）不应该在大型系统的底层[(见](#second)[ 2 节)](#second)实现。但底层可以提供方便端系统工作的功能，并最终可能改善性能。

这种观点表明底层系统功能不应以完美为设计目标，这是因为对端系统中的应用程序做出完美推测是不可能的。

最终，端到端论点倾向于基于 “一个哑网络和连接到这个哑网络的智能系统” 的结构设计方案。由此，TCP/IP 协议族中的很多功能：数据完整、发送控制速率都是在终端系统中的应用程序中实现的。至于哪些功能在同一个计算机、网络或软件栈中实现，这是另外一个称为[命运共](https://web.mit.edu/6.033/www/papers/darpa.pdf)[享](https://web.mit.edu/6.033/www/papers/darpa.pdf)的原则。

命运共享原则建议将必要的状态放在终端系统中，这些状态用于维护一个正在使用的网络通信。通常，一个端点失效时，整个通信也就失效了，中间底层设备的状态维护将不存在任何意义，且也浪费资源。这样，即使中间底层设备出了短暂的故障，也能维持整个通信关联性，因为通信的关联性都在终端系统中，不会因为底层设备出现故障导致通信关联性消失。即使一段时间内整个故障设备无法恢复，也能通过其他底层的通信中间设备恢复通信链路。通信链路概念为虚拟的，是一种虚拟的连接（例如：由 TCP 实现通信关联），即逻辑链路，是路径可变化的。

命运共享论点也支持一种 “带智能终端主机的哑网络” 模型，当前 Internet 中主要矛盾是：哪些功能在网络中实现，哪些功能不在网络中实现。

#### 1.3 差错控制和流量控制

网络中可能出现数据损坏或丢失的情况。这可能出于各种原因：硬件问题、数据传输过程中意外的修改、超出无线网络传输范围等。对于这类错误的处理称为差错控制，可以在网络基础设施系统、网络终端系统或其他组合中实现。显然，端到端和命运共享论点建议在应用程序附近或内部实现差错控制。

通常，在只有少数数据位出错的情况下（此处关注错误位置是在传输过程中或已接收的情况），通常可以通过网络中执行数学代码检测和修复这种位错误。当更多严重损坏发生在网络中时，整个分组通常被重新发送或重新传输。在线路网络或虚拟电路网络中，通常传输在网络内部进行。

这对于对分组数据顺序要求严格和无差错的应用是很有用的。但是有些应用不希望为数据的可靠交付而付出代价（建立连接或重新传输带来的延迟），例如文件传输就不需要顺序，只需要将分散的文件数据块按照原来的顺序重新组合即可。

针对网络中可靠、按顺序交付的实现考量，帧中继和 Internet 协议采用一种尽力而为的交付服务。这样尽力而为的交付中，网络不会花很大的努力来确保数据在没有差别或缺陷的情况下交付。但也会采用差错检测码或校验和来检测某些差错，例如可能一个数据包定向的差错，被检测到时，数据报仅仅丢弃而不会有进一步的动作。

如果尽力而为的交付成功，发送方能以超过接收方接收能力的速度发送数据。在尽力而为交付的 IP 网络中，降低发送方的发送速率可通过流量控制实现，它在网络外部或通信系统的高层实现并运行。TCP 会处理这样的问题（原书第 15 章和 16 章有介绍）。这与端到端论点表现一致：TCP 在终端主机中实现速率控制。也与命运共享论点一致：在基础设施单元中失效的情况下，不会影响网络设备的通信能力（只要某些通信路径仍然可用）。

### 2. 设计和实现 {#second}

虽然建议用一个特定的方式实现一个协议体系结构，但通常不是强制的。因此需要对协议体系结构和实现体系结构加以区分，实现体系结构定义了协议体系结构中的概念如何以软件形式实现。

很多负责实现 ARPANET 协议的人员非常熟悉操作系统的软件结构，一篇有影响力的论文描述的 “THE” 多编程系统 \[D68]，主张使用一种具有层次结构的处理方式，检查一个大型软件实现逻辑的稳定性和正确性。最终，这帮助形成了网络协议的设计理念，它涉及实现和设计了多个网络层次，这种方案现在称为分层，是实现协议族的常用方案。

#### 2.1 分层

通过分层，每层协议只负责通信的一个方面。这样的好处是显然的：允许不同专业领域的开发人员实现不同的部分。最常提到的协议分层概念基于一个称为 “开放系统互连标准（OSI）” 的模型。Internet 的分层模型更简单，在[第 3 节](#three)[：TCP/](#three)[IP 协议](#three)[结构和协议](#three)介绍。

尽管 OSI 建议的 7 个逻辑层在协议体系中结构的模块化实现是可取的，但是本文所介绍的 TCP/IP 体系结构（现实大部分网络体系结构）仅包含 5 层。在 20 世纪 70 年代，有很多关于 OSI 模型的不足和相对优势，以及 ARPANET 优于它的争论，但最后 TCP/IP 最终取得胜利。原书对网络层或互联网络层最有兴趣。



<table>
    <caption style="width:100%;">iso定义的7层osi模型, 每个网络设备并不需要实现所有的协议. 其术语和层数被广泛使用</caption>

  <colgroup>
    <col style="width: 1rem;">
    <col style="width: 3rem">
    <col style="width: 4rem;">
    <col style="width: 70%">
  </colgroup>
  <thead>
    <tr>
      <th></th>
      <th>层级</th>
      <th>名称</th>
      <th>描述/例子</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="4">主机</td>
      <td>7</td>
      <td>应用层</td>
      <td>指定完成某些用户初始化任务的方法。应用协议通常由应用程序开发者设计和实现，例如 FTP、Skype</td>
    </tr>
    <tr>
      <td>6</td>
      <td>表示层</td>
      <td>指定针对应用的数据表示格式和转换规则的方法。加密有时候也在本层，也可能在其他层</td>
    </tr>
    <tr>
      <td>5</td>
      <td>会话层</td>
      <td>指定由多个连接组成一个通信会话的方法，它可能关闭连接、重启连接和检查点进程</td>
    </tr>
    <tr>
      <td>4</td>
      <td>传输层</td>
      <td>指定运行在相同计算机系统中多个程序之间的连接或关联的方法。如果在其他地方没有实现，本层可能实现可靠的投递。如 TCP、ISO TP4</td>
    </tr>
    <tr>
      <td rowspan="3">所有网络设备</td>
      <td>3</td>
      <td>网络层</td>
      <td>指定经过潜在不同类型链路层网络的多跳通信方法。对于分组网络，它描述了抽象的分组格式和标准的编码结构，如 IP 数据报、X.25 PLP、ISO CLNP</td>
    </tr>
    <tr>
      <td>2</td>
      <td>链路层</td>
      <td>指定经过单一链路通信的方法，包括多个系统共享同一介质时的访问控制协议。本层通常包含差错检测和链路层地址格式，例如以太网、WiFi</td>
    </tr>
    <tr>
      <td>1</td>
      <td>物理层</td>
      <td>连接器、数据速率和如何在某些物理介质上进行位编码。本层也描述底层的差错检测和纠正、频率分配。原书将尽量避开这层</td>
    </tr>

  </tbody>
    <tfooter></tfooter>
</table>


#### 2.2 分层的复用、分解和封装的实现

分层体系结构的一个主要优点就是协议复用能力。其允许多种协议共存于同一基础设施中，也允许多个相同的协议对象多个实例同时存在，并且不会混淆。

一般来说，每一层有属于该层协议的数字标识，用于在该层级传输，并用于识别该分组携带的数据包属于该层的哪种协议或信息流。例如，链路层（以太网、WiFi）接收到来自相邻的上层数据报（IP 数据报）时，会将整个数据报数字位前面或数据位最后加一个标识符用来标识，用以标识是否是 IP 数据流。类似在数据前面加标识的过程称之为封装，用以标识本层的传输办法（协议）。

通常，上述链路层对相邻上层（IP 数据报）的数据报作为不可理解（不透明）数据，无条件执行封装传输，并形成一个本层的协议数据包，这个包可称之为 “协议数据单元（PDU）”。类似的，网络层（IP 数据报）的相邻上层也会下发网络层分组数据，由网络层处理程序将相邻上层（传输层）的数据包在数据位前面加一些标识符，形成网络层的协议数据单元，并转发给下层网络（程序）处理。

通常，更底层的网络会承诺不查看上层 PDU 的内容，这是封装的本质，每一层都将来自于上层的数据看为不可解析、无需解释的信息。

当数据在本层发送后，来到本层网络接收方按照协议规定的头部或尾部获得自己层所需要的标识位后就将这部分被加上标识的数据删除（解析、分解、拆分），并将这部分内容当作上层网络协议数据单元（PDU）。

因此，工作在底层的网络，通常不需要实现上层网络的协议，因为它为上层网络执行网络传输，并不需要处理上层网络的 PDU，因此不需要实现上层网络的协议（处理程序）。甚至，底层网络有属于自己层的专属协议，用于相同设备之间的协商和维护，不会转发到上层网络。

但实际情况不是这样的，当前的交换机和路由器通常实现更多的协议，这已经超出单纯实现数据转发的需要。原因通常包括出于管理的需要，例如允许远程登录，这通常需要实现更多的协议，已经可以充当一台主机了！

路由器通常包含多个网络接口，用于连接两个或多个网络。拥有多个网络接口的设备称之为多宿主。

一台主机可以是多宿主的，如果这台主机专门用于将一个分组从一个接口转发到另外一个接口，否则，不能把这台主机称之为路由器。

互联网络的目标之一是对应用隐藏所有有关于物理布局（拓扑）和底层协议的异构性细节。

### 3. TCP/IP 协议结构和协议 {#three}

目前为止，已经介绍了体系结构、协议、协议族和抽象的实现技术。本节将讨论构成 TCP/IP 协议族的体系结构和特定协议。虽然这已成为 Internet 使用的协议的既定术语，但是也有很多 TCP 和 IP 以外的协议包含在 Internet 使用的协议集合和协议族中。我们将从形成 Internet 协议分层基础的 ARPANET 模型开始介绍，探讨它和前面 OSI 模型


#### 3.1 ARPANET 参考模型


<table>
    <caption style="width:100%;">基于ARM或tcp/ip的分层被用于Internet,此模型中没有正式的会话层和表示层.另外此模型中有几个不适合归入标准层的附属或辅助协议.他们为其他协议的运行提供重要功能.其中部分协议没有被ipv6使用. 例如: IGMP/ARP</caption>

  <colgroup>
    <col style="width: 1rem;">
    <col style="width: 3rem">
    <col style="width: 4rem;">
    <col style="width: 70%">
  </colgroup>
  <thead>
    <tr>
      <th></th>
      <th>层级</th>
      <th>名称</th>
      <th>描述/例子</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="2">主机</td>
      <td>7</td>
      <td>应用层</td>
      <td>实际上指的是Internet兼容的任何应用哦,包括网页(HTTP),dns,dhcp</td>
    </tr>
    <tr>
      <td>4</td>
      <td>传输层</td>
      <td>提供在抽象由应用管理的端口之间的数据交换.可能包括差错和流量控制.例如tcp,udp,sctp,dccp</td>
    </tr>
    <tr>
      <td rowspan="3">所有网络设备</td>
      <td>3.5</td>
      <td>网络层(辅助)</td>
      <td>协助完成网络层设置,管理和安全的非正式的层,例如:ICMP,IGMP,IPsec</td>
    </tr>
    <tr>
      <td>3</td>
      <td>网络层</td>
      <td>定义抽象的数据报和提供路由,例子:ip(32位,64kb),ipv6(128位,最大支持4gb)</td>
    </tr>
    <tr>
      <td>2.5</td>
      <td>链路层(辅助)</td>
      <td>用于网络层到基于多接入链路层网络的链路层的地址映射和非正式的层,例子:ARP</td>
    </tr>


  </tbody>
    <tfooter></tfooter>
</table>

#### 3.2 TCP/IP 中的复用、分解和封装

简单来说，网络层到链路层的数据报（IP PDU，即 IP 协议数据单元），会经过分片操作，并被切割（分装）为数据帧。

#### 3.3 端口号

端口号是 16 位的非负整数（0-65535）。在物理上，这些端口并不存在，它是终端主机中存在的逻辑概念。该概念通常与 IP 地址结合使用，每个 IP 地址通常可以使用 65536 个端口号。大多数传输协议会使用这些端口号，它们通常绑定到主机上运行的具体服务。

由于某些与特定服务关联的端口经常被使用，标准的端口号由 Internet 号码分配机构（IANA）定义，分为熟知端口号（0-1023）、注册端口号（1024-49151）、动态 / 私有端口号（49152-65535）。传统上，服务器端软件需要绑定到熟知端口，这通常需要管理员或超级管理员这样的特殊权限。

#### 3.4 ip地址和域名服务(DNS)

在tcp/ip网络协议族中,每台计算机(包括路由器)的每个链路层接口至少有一个ip地址. 虽然ip地址足以识别主机,但是不方便被记忆(ipv6就更长了). 由此产生的dns服务, 此服务是一个分布式数据库.

提供主机名(域名)和ip地址之间的转换, 也可查询ip到域名的查询. 域名通常是以`.`分割的单词组合, 通常以.com,.org,.gov,.in,.uk,.edu等结尾. DNS服务本身属于一个应用层协议,因此DNS服务依赖于
其他协议. 虽然tcp/ip协议本身不关心域名, 但是用户(例如使用web浏览器)通常会使用域名,如果dns不能正常工作,正常的Internet访问也难以使用. (第11章介绍DNS)


### 4. Internet中的内网(内联网)和外网(外联网)

根据本章第一节提到的, 由大写字母开头的Internet表示世界范围内可以使用Tcp/ip协议的主机集合, 由小写字母开头的internet则表示使用常见协议族的多个网络.


那么internet则表示的范围要大于Internet, 因此可以说Internet是一个internet

### 5. 应用设计

#### 5.1 客户机/服务器

#### 5.2 对等


### 6. 标准化进程

#### 组织



1.  **IETF（Internet 工程任务组）**：每年在世界不同地点举行 3 次会议，负责开发、讨论并通过 Internet 的核心协议标准，承担着繁重且细致的工作。工作组主席负责协调执行此任务的志愿者，该会议并非免费。

2.  **IAB（Internet 架构委员会）**：由 IETF 选举产生，负责指导 IETF 的活动并执行相关任务，例如任命标准制定组的联络员。

3.  **IESG（Internet 工程指导组）**：由 IETF 选举产生，拥有决策权，可修改现有标准，建立和审批新的标准。

4.  **SDO（Internet 标准制定组）**

5.  **IRTF**：研究讨论那些尚未成熟到足以形成标准的协议、体系结构和程序，其主席是 IAB 的列席成员。

6.  **ISOC（Internet 协会）**：与 IAB 共同影响和促进涉及 Internet 技术和使用的相关政策与培训工作。

#### 6.1 RFC

Internet 的每个官方标准均以 RFC（征求意见稿）的形式发布。

#### 6.2 其他标准



1.  **IEEE（电气和电子工程师学会）**

2.  **W3C（万维网联盟）**

3.  **ITU（国际电信联盟）**
